<html><style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
<pre>
<span class="lineno">    1 </span>{-# LANGUAGE BangPatterns #-}
<span class="lineno">    2 </span>{-# LANGUAGE CPP #-}
<span class="lineno">    3 </span>{-# LANGUAGE OverloadedStrings #-}
<span class="lineno">    4 </span>{-# LANGUAGE ScopedTypeVariables #-}
<span class="lineno">    5 </span>
<span class="lineno">    6 </span>-- | Contains web handlers to serve files from a directory.
<span class="lineno">    7 </span>module Snap.Util.FileServe
<span class="lineno">    8 </span>(
<span class="lineno">    9 </span>  getSafePath
<span class="lineno">   10 </span>  -- * Configuration for directory serving
<span class="lineno">   11 </span>, MimeMap
<span class="lineno">   12 </span>, HandlerMap
<span class="lineno">   13 </span>, DirectoryConfig(..)
<span class="lineno">   14 </span>, simpleDirectoryConfig
<span class="lineno">   15 </span>, defaultDirectoryConfig
<span class="lineno">   16 </span>, fancyDirectoryConfig
<span class="lineno">   17 </span>, defaultIndexGenerator
<span class="lineno">   18 </span>, defaultMimeTypes
<span class="lineno">   19 </span>  -- * File servers
<span class="lineno">   20 </span>, serveDirectory
<span class="lineno">   21 </span>, serveDirectoryWith
<span class="lineno">   22 </span>, serveFile
<span class="lineno">   23 </span>, serveFileAs
<span class="lineno">   24 </span>  -- * Deprecated interface
<span class="lineno">   25 </span>, fileServe
<span class="lineno">   26 </span>, fileServe'
<span class="lineno">   27 </span>, fileServeSingle
<span class="lineno">   28 </span>, fileServeSingle'
<span class="lineno">   29 </span>) where
<span class="lineno">   30 </span>
<span class="lineno">   31 </span>------------------------------------------------------------------------------
<span class="lineno">   32 </span>import           Blaze.ByteString.Builder
<span class="lineno">   33 </span>import           Blaze.ByteString.Builder.Char8
<span class="lineno">   34 </span>import           Control.Applicative
<span class="lineno">   35 </span>import           Control.Monad
<span class="lineno">   36 </span>import           Control.Monad.Trans
<span class="lineno">   37 </span>import           Data.Attoparsec.Char8 hiding (Done)
<span class="lineno">   38 </span>import qualified Data.ByteString.Char8 as S
<span class="lineno">   39 </span>import           Data.ByteString.Char8 (ByteString)
<span class="lineno">   40 </span>import           Data.ByteString.Internal (c2w)
<span class="lineno">   41 </span>import           Data.Int
<span class="lineno">   42 </span>import           Data.List
<span class="lineno">   43 </span>import           Data.Map (Map)
<span class="lineno">   44 </span>import qualified Data.Map as Map
<span class="lineno">   45 </span>import           Data.Maybe (fromMaybe, isNothing)
<span class="lineno">   46 </span>import           Data.Monoid
<span class="lineno">   47 </span>import           Prelude hiding (show, Show)
<span class="lineno">   48 </span>import qualified Prelude
<span class="lineno">   49 </span>import           System.Directory
<span class="lineno">   50 </span>import           System.FilePath
<span class="lineno">   51 </span>import           System.PosixCompat.Files
<span class="lineno">   52 </span>------------------------------------------------------------------------------
<span class="lineno">   53 </span>import           Snap.Internal.Debug
<span class="lineno">   54 </span>import           Snap.Internal.Parsing
<span class="lineno">   55 </span>import           Snap.Iteratee hiding (drop)
<span class="lineno">   56 </span>import           Snap.Types
<span class="lineno">   57 </span>
<span class="lineno">   58 </span>
<span class="lineno">   59 </span>------------------------------------------------------------------------------
<span class="lineno">   60 </span>-- | Gets a path from the 'Request' using 'rqPathInfo' and makes sure it is
<span class="lineno">   61 </span>-- safe to use for opening files.  A path is safe if it is a relative path
<span class="lineno">   62 </span>-- and has no &quot;..&quot; elements to escape the intended directory structure.
<span class="lineno">   63 </span>getSafePath :: MonadSnap m =&gt; m FilePath
<span class="lineno">   64 </span><span class="decl"><span class="istickedoff">getSafePath = do</span>
<span class="lineno">   65 </span><span class="spaces">    </span><span class="istickedoff">req &lt;- getRequest</span>
<span class="lineno">   66 </span><span class="spaces">    </span><span class="istickedoff">let mp = urlDecode $ rqPathInfo req</span>
<span class="lineno">   67 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">   68 </span><span class="spaces">    </span><span class="istickedoff">p &lt;- maybe <span class="nottickedoff">pass</span> (return . S.unpack) mp</span>
<span class="lineno">   69 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">   70 </span><span class="spaces">    </span><span class="istickedoff">-- relative paths only!</span>
<span class="lineno">   71 </span><span class="spaces">    </span><span class="istickedoff">when (not $ isRelative p) pass</span>
<span class="lineno">   72 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">   73 </span><span class="spaces">    </span><span class="istickedoff">-- check that we don't have any sneaky .. paths</span>
<span class="lineno">   74 </span><span class="spaces">    </span><span class="istickedoff">let dirs = splitDirectories p</span>
<span class="lineno">   75 </span><span class="spaces">    </span><span class="istickedoff">when (elem &quot;..&quot; dirs) pass</span>
<span class="lineno">   76 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">   77 </span><span class="spaces">    </span><span class="istickedoff">return $ joinPath dirs</span></span>
<span class="lineno">   78 </span>
<span class="lineno">   79 </span>
<span class="lineno">   80 </span>------------------------------------------------------------------------------
<span class="lineno">   81 </span>-- | A type alias for dynamic handlers
<span class="lineno">   82 </span>type HandlerMap m = Map FilePath (FilePath -&gt; m ())
<span class="lineno">   83 </span>
<span class="lineno">   84 </span>
<span class="lineno">   85 </span>------------------------------------------------------------------------------
<span class="lineno">   86 </span>-- | A type alias for MIME type
<span class="lineno">   87 </span>type MimeMap = Map FilePath ByteString
<span class="lineno">   88 </span>
<span class="lineno">   89 </span>
<span class="lineno">   90 </span>------------------------------------------------------------------------------
<span class="lineno">   91 </span>-- | The default set of mime type mappings we use when serving files. Its
<span class="lineno">   92 </span>-- value:
<span class="lineno">   93 </span>--
<span class="lineno">   94 </span>-- &gt; Map.fromList [
<span class="lineno">   95 </span>-- &gt;   ( &quot;.asc&quot;     , &quot;text/plain&quot;                        ),
<span class="lineno">   96 </span>-- &gt;   ( &quot;.asf&quot;     , &quot;video/x-ms-asf&quot;                    ),
<span class="lineno">   97 </span>-- &gt;   ( &quot;.asx&quot;     , &quot;video/x-ms-asf&quot;                    ),
<span class="lineno">   98 </span>-- &gt;   ( &quot;.avi&quot;     , &quot;video/x-msvideo&quot;                   ),
<span class="lineno">   99 </span>-- &gt;   ( &quot;.bz2&quot;     , &quot;application/x-bzip&quot;                ),
<span class="lineno">  100 </span>-- &gt;   ( &quot;.c&quot;       , &quot;text/plain&quot;                        ),
<span class="lineno">  101 </span>-- &gt;   ( &quot;.class&quot;   , &quot;application/octet-stream&quot;          ),
<span class="lineno">  102 </span>-- &gt;   ( &quot;.conf&quot;    , &quot;text/plain&quot;                        ),
<span class="lineno">  103 </span>-- &gt;   ( &quot;.cpp&quot;     , &quot;text/plain&quot;                        ),
<span class="lineno">  104 </span>-- &gt;   ( &quot;.css&quot;     , &quot;text/css&quot;                          ),
<span class="lineno">  105 </span>-- &gt;   ( &quot;.cxx&quot;     , &quot;text/plain&quot;                        ),
<span class="lineno">  106 </span>-- &gt;   ( &quot;.dtd&quot;     , &quot;text/xml&quot;                          ),
<span class="lineno">  107 </span>-- &gt;   ( &quot;.dvi&quot;     , &quot;application/x-dvi&quot;                 ),
<span class="lineno">  108 </span>-- &gt;   ( &quot;.gif&quot;     , &quot;image/gif&quot;                         ),
<span class="lineno">  109 </span>-- &gt;   ( &quot;.gz&quot;      , &quot;application/x-gzip&quot;                ),
<span class="lineno">  110 </span>-- &gt;   ( &quot;.hs&quot;      , &quot;text/plain&quot;                        ),
<span class="lineno">  111 </span>-- &gt;   ( &quot;.htm&quot;     , &quot;text/html&quot;                         ),
<span class="lineno">  112 </span>-- &gt;   ( &quot;.html&quot;    , &quot;text/html&quot;                         ),
<span class="lineno">  113 </span>-- &gt;   ( &quot;.jar&quot;     , &quot;application/x-java-archive&quot;        ),
<span class="lineno">  114 </span>-- &gt;   ( &quot;.jpeg&quot;    , &quot;image/jpeg&quot;                        ),
<span class="lineno">  115 </span>-- &gt;   ( &quot;.jpg&quot;     , &quot;image/jpeg&quot;                        ),
<span class="lineno">  116 </span>-- &gt;   ( &quot;.js&quot;      , &quot;text/javascript&quot;                   ),
<span class="lineno">  117 </span>-- &gt;   ( &quot;.log&quot;     , &quot;text/plain&quot;                        ),
<span class="lineno">  118 </span>-- &gt;   ( &quot;.m3u&quot;     , &quot;audio/x-mpegurl&quot;                   ),
<span class="lineno">  119 </span>-- &gt;   ( &quot;.mov&quot;     , &quot;video/quicktime&quot;                   ),
<span class="lineno">  120 </span>-- &gt;   ( &quot;.mp3&quot;     , &quot;audio/mpeg&quot;                        ),
<span class="lineno">  121 </span>-- &gt;   ( &quot;.mpeg&quot;    , &quot;video/mpeg&quot;                        ),
<span class="lineno">  122 </span>-- &gt;   ( &quot;.mpg&quot;     , &quot;video/mpeg&quot;                        ),
<span class="lineno">  123 </span>-- &gt;   ( &quot;.ogg&quot;     , &quot;application/ogg&quot;                   ),
<span class="lineno">  124 </span>-- &gt;   ( &quot;.pac&quot;     , &quot;application/x-ns-proxy-autoconfig&quot; ),
<span class="lineno">  125 </span>-- &gt;   ( &quot;.pdf&quot;     , &quot;application/pdf&quot;                   ),
<span class="lineno">  126 </span>-- &gt;   ( &quot;.png&quot;     , &quot;image/png&quot;                         ),
<span class="lineno">  127 </span>-- &gt;   ( &quot;.ps&quot;      , &quot;application/postscript&quot;            ),
<span class="lineno">  128 </span>-- &gt;   ( &quot;.qt&quot;      , &quot;video/quicktime&quot;                   ),
<span class="lineno">  129 </span>-- &gt;   ( &quot;.sig&quot;     , &quot;application/pgp-signature&quot;         ),
<span class="lineno">  130 </span>-- &gt;   ( &quot;.spl&quot;     , &quot;application/futuresplash&quot;          ),
<span class="lineno">  131 </span>-- &gt;   ( &quot;.swf&quot;     , &quot;application/x-shockwave-flash&quot;     ),
<span class="lineno">  132 </span>-- &gt;   ( &quot;.tar&quot;     , &quot;application/x-tar&quot;                 ),
<span class="lineno">  133 </span>-- &gt;   ( &quot;.tar.bz2&quot; , &quot;application/x-bzip-compressed-tar&quot; ),
<span class="lineno">  134 </span>-- &gt;   ( &quot;.tar.gz&quot;  , &quot;application/x-tgz&quot;                 ),
<span class="lineno">  135 </span>-- &gt;   ( &quot;.tbz&quot;     , &quot;application/x-bzip-compressed-tar&quot; ),
<span class="lineno">  136 </span>-- &gt;   ( &quot;.text&quot;    , &quot;text/plain&quot;                        ),
<span class="lineno">  137 </span>-- &gt;   ( &quot;.tgz&quot;     , &quot;application/x-tgz&quot;                 ),
<span class="lineno">  138 </span>-- &gt;   ( &quot;.torrent&quot; , &quot;application/x-bittorrent&quot;          ),
<span class="lineno">  139 </span>-- &gt;   ( &quot;.txt&quot;     , &quot;text/plain&quot;                        ),
<span class="lineno">  140 </span>-- &gt;   ( &quot;.wav&quot;     , &quot;audio/x-wav&quot;                       ),
<span class="lineno">  141 </span>-- &gt;   ( &quot;.wax&quot;     , &quot;audio/x-ms-wax&quot;                    ),
<span class="lineno">  142 </span>-- &gt;   ( &quot;.wma&quot;     , &quot;audio/x-ms-wma&quot;                    ),
<span class="lineno">  143 </span>-- &gt;   ( &quot;.wmv&quot;     , &quot;video/x-ms-wmv&quot;                    ),
<span class="lineno">  144 </span>-- &gt;   ( &quot;.xbm&quot;     , &quot;image/x-xbitmap&quot;                   ),
<span class="lineno">  145 </span>-- &gt;   ( &quot;.xml&quot;     , &quot;text/xml&quot;                          ),
<span class="lineno">  146 </span>-- &gt;   ( &quot;.xpm&quot;     , &quot;image/x-xpixmap&quot;                   ),
<span class="lineno">  147 </span>-- &gt;   ( &quot;.xwd&quot;     , &quot;image/x-xwindowdump&quot;               ),
<span class="lineno">  148 </span>-- &gt;   ( &quot;.zip&quot;     , &quot;application/zip&quot;                   ) ]
<span class="lineno">  149 </span>--
<span class="lineno">  150 </span>defaultMimeTypes :: MimeMap
<span class="lineno">  151 </span><span class="decl"><span class="istickedoff">defaultMimeTypes = Map.fromList [</span>
<span class="lineno">  152 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.asc&quot;     , &quot;text/plain&quot;                        ),</span>
<span class="lineno">  153 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.asf&quot;     , &quot;video/x-ms-asf&quot;                    ),</span>
<span class="lineno">  154 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.asx&quot;     , &quot;video/x-ms-asf&quot;                    ),</span>
<span class="lineno">  155 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.avi&quot;     , &quot;video/x-msvideo&quot;                   ),</span>
<span class="lineno">  156 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.bz2&quot;     , &quot;application/x-bzip&quot;                ),</span>
<span class="lineno">  157 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.c&quot;       , &quot;text/plain&quot;                        ),</span>
<span class="lineno">  158 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.class&quot;   , &quot;application/octet-stream&quot;          ),</span>
<span class="lineno">  159 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.conf&quot;    , &quot;text/plain&quot;                        ),</span>
<span class="lineno">  160 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.cpp&quot;     , &quot;text/plain&quot;                        ),</span>
<span class="lineno">  161 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.css&quot;     , &quot;text/css&quot;                          ),</span>
<span class="lineno">  162 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.cxx&quot;     , &quot;text/plain&quot;                        ),</span>
<span class="lineno">  163 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.dtd&quot;     , &quot;text/xml&quot;                          ),</span>
<span class="lineno">  164 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.dvi&quot;     , &quot;application/x-dvi&quot;                 ),</span>
<span class="lineno">  165 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.gif&quot;     , &quot;image/gif&quot;                         ),</span>
<span class="lineno">  166 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.gz&quot;      , &quot;application/x-gzip&quot;                ),</span>
<span class="lineno">  167 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.hs&quot;      , &quot;text/plain&quot;                        ),</span>
<span class="lineno">  168 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.htm&quot;     , &quot;text/html&quot;                         ),</span>
<span class="lineno">  169 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.html&quot;    , &quot;text/html&quot;                         ),</span>
<span class="lineno">  170 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.jar&quot;     , &quot;application/x-java-archive&quot;        ),</span>
<span class="lineno">  171 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.jpeg&quot;    , &quot;image/jpeg&quot;                        ),</span>
<span class="lineno">  172 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.jpg&quot;     , &quot;image/jpeg&quot;                        ),</span>
<span class="lineno">  173 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.js&quot;      , &quot;text/javascript&quot;                   ),</span>
<span class="lineno">  174 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.log&quot;     , &quot;text/plain&quot;                        ),</span>
<span class="lineno">  175 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.m3u&quot;     , &quot;audio/x-mpegurl&quot;                   ),</span>
<span class="lineno">  176 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.mov&quot;     , &quot;video/quicktime&quot;                   ),</span>
<span class="lineno">  177 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.mp3&quot;     , &quot;audio/mpeg&quot;                        ),</span>
<span class="lineno">  178 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.mpeg&quot;    , &quot;video/mpeg&quot;                        ),</span>
<span class="lineno">  179 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.mpg&quot;     , &quot;video/mpeg&quot;                        ),</span>
<span class="lineno">  180 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.ogg&quot;     , &quot;application/ogg&quot;                   ),</span>
<span class="lineno">  181 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.pac&quot;     , &quot;application/x-ns-proxy-autoconfig&quot; ),</span>
<span class="lineno">  182 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.pdf&quot;     , &quot;application/pdf&quot;                   ),</span>
<span class="lineno">  183 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.png&quot;     , &quot;image/png&quot;                         ),</span>
<span class="lineno">  184 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.ps&quot;      , &quot;application/postscript&quot;            ),</span>
<span class="lineno">  185 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.qt&quot;      , &quot;video/quicktime&quot;                   ),</span>
<span class="lineno">  186 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.sig&quot;     , &quot;application/pgp-signature&quot;         ),</span>
<span class="lineno">  187 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.spl&quot;     , &quot;application/futuresplash&quot;          ),</span>
<span class="lineno">  188 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.swf&quot;     , &quot;application/x-shockwave-flash&quot;     ),</span>
<span class="lineno">  189 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.tar&quot;     , &quot;application/x-tar&quot;                 ),</span>
<span class="lineno">  190 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.tar.bz2&quot; , &quot;application/x-bzip-compressed-tar&quot; ),</span>
<span class="lineno">  191 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.tar.gz&quot;  , &quot;application/x-tgz&quot;                 ),</span>
<span class="lineno">  192 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.tbz&quot;     , &quot;application/x-bzip-compressed-tar&quot; ),</span>
<span class="lineno">  193 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.text&quot;    , &quot;text/plain&quot;                        ),</span>
<span class="lineno">  194 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.tgz&quot;     , &quot;application/x-tgz&quot;                 ),</span>
<span class="lineno">  195 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.torrent&quot; , &quot;application/x-bittorrent&quot;          ),</span>
<span class="lineno">  196 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.ttf&quot;     , &quot;application/x-font-truetype&quot;       ),</span>
<span class="lineno">  197 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.txt&quot;     , &quot;text/plain&quot;                        ),</span>
<span class="lineno">  198 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.wav&quot;     , &quot;audio/x-wav&quot;                       ),</span>
<span class="lineno">  199 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.wax&quot;     , &quot;audio/x-ms-wax&quot;                    ),</span>
<span class="lineno">  200 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.wma&quot;     , &quot;audio/x-ms-wma&quot;                    ),</span>
<span class="lineno">  201 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.wmv&quot;     , &quot;video/x-ms-wmv&quot;                    ),</span>
<span class="lineno">  202 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.xbm&quot;     , &quot;image/x-xbitmap&quot;                   ),</span>
<span class="lineno">  203 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.xml&quot;     , &quot;text/xml&quot;                          ),</span>
<span class="lineno">  204 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.xpm&quot;     , &quot;image/x-xpixmap&quot;                   ),</span>
<span class="lineno">  205 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.xwd&quot;     , &quot;image/x-xwindowdump&quot;               ),</span>
<span class="lineno">  206 </span><span class="spaces">  </span><span class="istickedoff">( &quot;.zip&quot;     , &quot;application/zip&quot;                   ) ]</span></span>
<span class="lineno">  207 </span>
<span class="lineno">  208 </span>
<span class="lineno">  209 </span>------------------------------------------------------------------------------
<span class="lineno">  210 </span>-- | A collection of options for serving static files out of a directory.
<span class="lineno">  211 </span>data <span class="istickedoff">DirectoryConfig</span> m = DirectoryConfig {
<span class="lineno">  212 </span>    -- | Files to look for when a directory is requested (e.g., index.html)
<span class="lineno">  213 </span>    indexFiles      :: [FilePath],
<span class="lineno">  214 </span>
<span class="lineno">  215 </span>    -- | Handler to generate a directory listing if there is no index.
<span class="lineno">  216 </span>    indexGenerator  :: FilePath -&gt; m (),
<span class="lineno">  217 </span>
<span class="lineno">  218 </span>    -- | Map of extensions to pass to dynamic file handlers.  This could be
<span class="lineno">  219 </span>    -- used, for example, to implement CGI dispatch, pretty printing of source
<span class="lineno">  220 </span>    -- code, etc.
<span class="lineno">  221 </span>    dynamicHandlers :: HandlerMap m,
<span class="lineno">  222 </span>
<span class="lineno">  223 </span>    -- | MIME type map to look up content types.
<span class="lineno">  224 </span>    mimeTypes       :: MimeMap,
<span class="lineno">  225 </span>
<span class="lineno">  226 </span>    -- | Handler that is called before a file is served.  It will only be
<span class="lineno">  227 </span>    -- called when a file is actually found, not for generated index pages.
<span class="lineno">  228 </span>    preServeHook    :: FilePath -&gt; m ()
<span class="lineno">  229 </span>    }
<span class="lineno">  230 </span>
<span class="lineno">  231 </span>
<span class="lineno">  232 </span>------------------------------------------------------------------------------
<span class="lineno">  233 </span>-- | Style information for the default directory index generator.
<span class="lineno">  234 </span>snapIndexStyles :: ByteString
<span class="lineno">  235 </span><span class="decl"><span class="istickedoff">snapIndexStyles =</span>
<span class="lineno">  236 </span><span class="spaces">    </span><span class="istickedoff">&quot;body { margin: 0px 0px 0px 0px; font-family: sans-serif }&quot;</span>
<span class="lineno">  237 </span><span class="spaces">    </span><span class="istickedoff">`S.append` &quot;div.header {&quot;</span>
<span class="lineno">  238 </span><span class="spaces">    </span><span class="istickedoff">`S.append`     &quot;padding: 40px 40px 0px 40px; height:35px;&quot;</span>
<span class="lineno">  239 </span><span class="spaces">    </span><span class="istickedoff">`S.append`     &quot;background:rgb(25,50,87);&quot;</span>
<span class="lineno">  240 </span><span class="spaces">    </span><span class="istickedoff">`S.append`     &quot;background-image:-webkit-gradient(&quot;</span>
<span class="lineno">  241 </span><span class="spaces">    </span><span class="istickedoff">`S.append`         &quot;linear,left bottom,left top,&quot;</span>
<span class="lineno">  242 </span><span class="spaces">    </span><span class="istickedoff">`S.append`         &quot;color-stop(0.00, rgb(31,62,108)),&quot;</span>
<span class="lineno">  243 </span><span class="spaces">    </span><span class="istickedoff">`S.append`         &quot;color-stop(1.00, rgb(19,38,66)));&quot;</span>
<span class="lineno">  244 </span><span class="spaces">    </span><span class="istickedoff">`S.append`     &quot;background-image:-moz-linear-gradient(&quot;</span>
<span class="lineno">  245 </span><span class="spaces">    </span><span class="istickedoff">`S.append`         &quot;center bottom,rgb(31,62,108) 0%,rgb(19,38,66) 100%);&quot;</span>
<span class="lineno">  246 </span><span class="spaces">    </span><span class="istickedoff">`S.append`     &quot;text-shadow:-1px 3px 1px rgb(16,33,57);&quot;</span>
<span class="lineno">  247 </span><span class="spaces">    </span><span class="istickedoff">`S.append`     &quot;font-size:16pt; letter-spacing: 2pt; color:white;&quot;</span>
<span class="lineno">  248 </span><span class="spaces">    </span><span class="istickedoff">`S.append`     &quot;border-bottom:10px solid rgb(46,93,156) }&quot;</span>
<span class="lineno">  249 </span><span class="spaces">    </span><span class="istickedoff">`S.append` &quot;div.content {&quot;</span>
<span class="lineno">  250 </span><span class="spaces">    </span><span class="istickedoff">`S.append`     &quot;background:rgb(255,255,255);&quot;</span>
<span class="lineno">  251 </span><span class="spaces">    </span><span class="istickedoff">`S.append`     &quot;background-image:-webkit-gradient(&quot;</span>
<span class="lineno">  252 </span><span class="spaces">    </span><span class="istickedoff">`S.append`         &quot;linear,left bottom, left top,&quot;</span>
<span class="lineno">  253 </span><span class="spaces">    </span><span class="istickedoff">`S.append`         &quot;color-stop(0.50, rgb(255,255,255)),&quot;</span>
<span class="lineno">  254 </span><span class="spaces">    </span><span class="istickedoff">`S.append`         &quot;color-stop(1.00, rgb(224,234,247)));&quot;</span>
<span class="lineno">  255 </span><span class="spaces">    </span><span class="istickedoff">`S.append`     &quot;background-image:-moz-linear-gradient(&quot;</span>
<span class="lineno">  256 </span><span class="spaces">    </span><span class="istickedoff">`S.append`         &quot;center bottom, white 50%, rgb(224,234,247) 100%);&quot;</span>
<span class="lineno">  257 </span><span class="spaces">    </span><span class="istickedoff">`S.append`     &quot;padding: 40px 40px 40px 40px }&quot;</span>
<span class="lineno">  258 </span><span class="spaces">    </span><span class="istickedoff">`S.append` &quot;div.footer {&quot;</span>
<span class="lineno">  259 </span><span class="spaces">    </span><span class="istickedoff">`S.append`     &quot;padding: 16px 0px 10px 10px; height:31px;&quot;</span>
<span class="lineno">  260 </span><span class="spaces">    </span><span class="istickedoff">`S.append`     &quot;border-top: 1px solid rgb(194,209,225);&quot;</span>
<span class="lineno">  261 </span><span class="spaces">    </span><span class="istickedoff">`S.append`     &quot;color: rgb(160,172,186); font-size:10pt;&quot;</span>
<span class="lineno">  262 </span><span class="spaces">    </span><span class="istickedoff">`S.append`     &quot;background: rgb(245,249,255) }&quot;</span>
<span class="lineno">  263 </span><span class="spaces">    </span><span class="istickedoff">`S.append` &quot;table { width:100% }&quot;</span>
<span class="lineno">  264 </span><span class="spaces">    </span><span class="istickedoff">`S.append` &quot;tr:hover { background:rgb(256,256,224) }&quot;</span>
<span class="lineno">  265 </span><span class="spaces">    </span><span class="istickedoff">`S.append` &quot;td { border:dotted thin black; font-family:monospace }&quot;</span>
<span class="lineno">  266 </span><span class="spaces">    </span><span class="istickedoff">`S.append` &quot;th { border:solid thin black; background:rgb(28,56,97);&quot;</span>
<span class="lineno">  267 </span><span class="spaces">    </span><span class="istickedoff">`S.append`      &quot;text-shadow:-1px 3px 1px rgb(16,33,57); color: white}&quot;</span></span>
<span class="lineno">  268 </span>
<span class="lineno">  269 </span>
<span class="lineno">  270 </span>------------------------------------------------------------------------------
<span class="lineno">  271 </span>-- | An automatic index generator, which is fairly small and does not rely on
<span class="lineno">  272 </span>-- any external files (which may not be there depending on external request
<span class="lineno">  273 </span>-- routing).
<span class="lineno">  274 </span>--
<span class="lineno">  275 </span>-- A 'MimeMap' is passed in to display the types of files in the directory
<span class="lineno">  276 </span>-- listing based on their extension.  Preferably, this is the same as the map
<span class="lineno">  277 </span>-- in the 'DirectoryConfig'
<span class="lineno">  278 </span>--
<span class="lineno">  279 </span>-- The styles parameter allows you to apply styles to the directory listing.
<span class="lineno">  280 </span>-- The listing itself consists of a table, containing a header row using
<span class="lineno">  281 </span>-- th elements, and one row per file using td elements, so styles for those
<span class="lineno">  282 </span>-- pieces may be attached to the appropriate tags.
<span class="lineno">  283 </span>defaultIndexGenerator :: MonadSnap m
<span class="lineno">  284 </span>                      =&gt; MimeMap    -- ^ MIME type mapping for reporting types
<span class="lineno">  285 </span>                      -&gt; ByteString -- ^ Style info to insert in header
<span class="lineno">  286 </span>                      -&gt; FilePath   -- ^ Directory to generate index for
<span class="lineno">  287 </span>                      -&gt; m ()
<span class="lineno">  288 </span><span class="decl"><span class="istickedoff">defaultIndexGenerator mm styles d = do</span>
<span class="lineno">  289 </span><span class="spaces">    </span><span class="istickedoff">modifyResponse $ setContentType <span class="nottickedoff">&quot;text/html&quot;</span></span>
<span class="lineno">  290 </span><span class="spaces">    </span><span class="istickedoff">rq      &lt;- getRequest</span>
<span class="lineno">  291 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  292 </span><span class="spaces">    </span><span class="istickedoff">let uri = uriWithoutQueryString rq</span>
<span class="lineno">  293 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  294 </span><span class="spaces">    </span><span class="istickedoff">writeBS &quot;&lt;style type='text/css'&gt;&quot;</span>
<span class="lineno">  295 </span><span class="spaces">    </span><span class="istickedoff">writeBS styles</span>
<span class="lineno">  296 </span><span class="spaces">    </span><span class="istickedoff">writeBS &quot;&lt;/style&gt;&lt;div class=\&quot;header\&quot;&gt;Directory Listing: &quot;</span>
<span class="lineno">  297 </span><span class="spaces">    </span><span class="istickedoff">writeBS uri</span>
<span class="lineno">  298 </span><span class="spaces">    </span><span class="istickedoff">writeBS &quot;&lt;/div&gt;&lt;div class=\&quot;content\&quot;&gt;&quot;</span>
<span class="lineno">  299 </span><span class="spaces">    </span><span class="istickedoff">writeBS &quot;&lt;table&gt;&lt;tr&gt;&lt;th&gt;File Name&lt;/th&gt;&lt;th&gt;Type&lt;/th&gt;&lt;th&gt;Last Modified&quot;</span>
<span class="lineno">  300 </span><span class="spaces">    </span><span class="istickedoff">writeBS &quot;&lt;/th&gt;&lt;/tr&gt;&quot;</span>
<span class="lineno">  301 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  302 </span><span class="spaces">    </span><span class="istickedoff">when (uri /= &quot;/&quot;) $</span>
<span class="lineno">  303 </span><span class="spaces">        </span><span class="istickedoff">writeBS &quot;&lt;tr&gt;&lt;td&gt;&lt;a href='../'&gt;..&lt;/a&gt;&lt;/td&gt;&lt;td colspan=2&gt;DIR&lt;/td&gt;&lt;/tr&gt;&quot;</span>
<span class="lineno">  304 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  305 </span><span class="spaces">    </span><span class="istickedoff">entries &lt;- liftIO $ getDirectoryContents d</span>
<span class="lineno">  306 </span><span class="spaces">    </span><span class="istickedoff">dirs    &lt;- liftIO $ filterM (doesDirectoryExist . (d &lt;/&gt;)) entries</span>
<span class="lineno">  307 </span><span class="spaces">    </span><span class="istickedoff">files   &lt;- liftIO $ filterM (doesFileExist . (d &lt;/&gt;)) entries</span>
<span class="lineno">  308 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  309 </span><span class="spaces">    </span><span class="istickedoff">forM_ (sort $ filter (not . (`elem` [&quot;..&quot;, &quot;.&quot;])) dirs) $ <span class="nottickedoff">\f -&gt; do</span></span>
<span class="lineno">  310 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">writeBS &quot;&lt;tr&gt;&lt;td&gt;&lt;a href='&quot;</span></span>
<span class="lineno">  311 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">writeBS (S.pack f)</span></span>
<span class="lineno">  312 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">writeBS &quot;/'&gt;&quot;</span></span>
<span class="lineno">  313 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">writeBS (S.pack f)</span></span>
<span class="lineno">  314 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">writeBS &quot;&lt;/a&gt;&lt;/td&gt;&lt;td colspan=2&gt;DIR&lt;/td&gt;&lt;/tr&gt;&quot;</span></span>
<span class="lineno">  315 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  316 </span><span class="spaces">    </span><span class="istickedoff">forM_ (sort files) $ \f -&gt; do</span>
<span class="lineno">  317 </span><span class="spaces">        </span><span class="istickedoff">stat &lt;- liftIO $ getFileStatus (d &lt;/&gt; f)</span>
<span class="lineno">  318 </span><span class="spaces">        </span><span class="istickedoff">tm   &lt;- liftIO $ formatHttpTime (modificationTime stat)</span>
<span class="lineno">  319 </span><span class="spaces">        </span><span class="istickedoff">writeBS &quot;&lt;tr&gt;&lt;td&gt;&lt;a href='&quot;</span>
<span class="lineno">  320 </span><span class="spaces">        </span><span class="istickedoff">writeBS (S.pack f)</span>
<span class="lineno">  321 </span><span class="spaces">        </span><span class="istickedoff">writeBS &quot;'&gt;&quot;</span>
<span class="lineno">  322 </span><span class="spaces">        </span><span class="istickedoff">writeBS (S.pack f)</span>
<span class="lineno">  323 </span><span class="spaces">        </span><span class="istickedoff">writeBS &quot;&lt;/a&gt;&lt;/td&gt;&lt;td&gt;&quot;</span>
<span class="lineno">  324 </span><span class="spaces">        </span><span class="istickedoff">writeBS (fileType mm f)</span>
<span class="lineno">  325 </span><span class="spaces">        </span><span class="istickedoff">writeBS &quot;&lt;/td&gt;&lt;td&gt;&quot;</span>
<span class="lineno">  326 </span><span class="spaces">        </span><span class="istickedoff">writeBS tm</span>
<span class="lineno">  327 </span><span class="spaces">        </span><span class="istickedoff">writeBS &quot;&lt;/tr&gt;&quot;</span>
<span class="lineno">  328 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  329 </span><span class="spaces">    </span><span class="istickedoff">writeBS &quot;&lt;/table&gt;&lt;/div&gt;&lt;div class=\&quot;footer\&quot;&gt;Powered by &quot;</span>
<span class="lineno">  330 </span><span class="spaces">    </span><span class="istickedoff">writeBS &quot;&lt;b&gt;&lt;a href=\&quot;http://snapframework.com\&quot;&gt;Snap&lt;/a&gt;&lt;/b&gt;&lt;/div&gt;&quot;</span></span>
<span class="lineno">  331 </span>
<span class="lineno">  332 </span>
<span class="lineno">  333 </span>------------------------------------------------------------------------------
<span class="lineno">  334 </span>-- | A very simple configuration for directory serving.  This configuration
<span class="lineno">  335 </span>-- uses built-in MIME types from 'defaultMimeTypes', and has no index files,
<span class="lineno">  336 </span>-- index generator, dynamic file handlers, or 'preServeHook'.
<span class="lineno">  337 </span>simpleDirectoryConfig :: MonadSnap m =&gt; DirectoryConfig m
<span class="lineno">  338 </span><span class="decl"><span class="nottickedoff">simpleDirectoryConfig = DirectoryConfig {</span>
<span class="lineno">  339 </span><span class="spaces">    </span><span class="nottickedoff">indexFiles = [],</span>
<span class="lineno">  340 </span><span class="spaces">    </span><span class="nottickedoff">indexGenerator = const pass,</span>
<span class="lineno">  341 </span><span class="spaces">    </span><span class="nottickedoff">dynamicHandlers = Map.empty,</span>
<span class="lineno">  342 </span><span class="spaces">    </span><span class="nottickedoff">mimeTypes = defaultMimeTypes,</span>
<span class="lineno">  343 </span><span class="spaces">    </span><span class="nottickedoff">preServeHook = const $ return ()</span>
<span class="lineno">  344 </span><span class="spaces">    </span><span class="nottickedoff">}</span></span>
<span class="lineno">  345 </span>
<span class="lineno">  346 </span>
<span class="lineno">  347 </span>------------------------------------------------------------------------------
<span class="lineno">  348 </span>-- | A reasonable default configuration for directory serving.  This
<span class="lineno">  349 </span>-- configuration uses built-in MIME types from 'defaultMimeTypes', serves
<span class="lineno">  350 </span>-- common index files @index.html@ and @index.htm@, but does not autogenerate
<span class="lineno">  351 </span>-- directory indexes, nor have any dynamic file handlers. The 'preServeHook'
<span class="lineno">  352 </span>-- will not do anything.
<span class="lineno">  353 </span>defaultDirectoryConfig :: MonadSnap m =&gt; DirectoryConfig m
<span class="lineno">  354 </span><span class="decl"><span class="istickedoff">defaultDirectoryConfig = DirectoryConfig {</span>
<span class="lineno">  355 </span><span class="spaces">    </span><span class="istickedoff">indexFiles = <span class="nottickedoff">[&quot;index.html&quot;, &quot;index.htm&quot;]</span>,</span>
<span class="lineno">  356 </span><span class="spaces">    </span><span class="istickedoff">indexGenerator = <span class="nottickedoff">const pass</span>,</span>
<span class="lineno">  357 </span><span class="spaces">    </span><span class="istickedoff">dynamicHandlers = Map.empty,</span>
<span class="lineno">  358 </span><span class="spaces">    </span><span class="istickedoff">mimeTypes = defaultMimeTypes,</span>
<span class="lineno">  359 </span><span class="spaces">    </span><span class="istickedoff">preServeHook = const $ return <span class="nottickedoff">()</span></span>
<span class="lineno">  360 </span><span class="spaces">    </span><span class="istickedoff">}</span></span>
<span class="lineno">  361 </span>
<span class="lineno">  362 </span>
<span class="lineno">  363 </span>------------------------------------------------------------------------------
<span class="lineno">  364 </span>-- | A more elaborate configuration for file serving.  This configuration
<span class="lineno">  365 </span>-- uses built-in MIME types from 'defaultMimeTypes', serves common index files
<span class="lineno">  366 </span>-- @index.html@ and @index.htm@, and autogenerates directory indexes with a
<span class="lineno">  367 </span>-- Snap-like feel.  It still has no dynamic file handlers, nor 'preServeHook',
<span class="lineno">  368 </span>-- which should be added as needed.
<span class="lineno">  369 </span>--
<span class="lineno">  370 </span>-- Files recognized as indexes include @index.html@, @index.htm@,
<span class="lineno">  371 </span>-- @default.html@, @default.htm@, @home.html@
<span class="lineno">  372 </span>fancyDirectoryConfig :: MonadSnap m =&gt; DirectoryConfig m
<span class="lineno">  373 </span><span class="decl"><span class="istickedoff">fancyDirectoryConfig = DirectoryConfig {</span>
<span class="lineno">  374 </span><span class="spaces">    </span><span class="istickedoff">indexFiles = [&quot;index.html&quot;, &quot;index.htm&quot;],</span>
<span class="lineno">  375 </span><span class="spaces">    </span><span class="istickedoff">indexGenerator = defaultIndexGenerator defaultMimeTypes snapIndexStyles,</span>
<span class="lineno">  376 </span><span class="spaces">    </span><span class="istickedoff">dynamicHandlers = <span class="nottickedoff">Map.empty</span>,</span>
<span class="lineno">  377 </span><span class="spaces">    </span><span class="istickedoff">mimeTypes = <span class="nottickedoff">defaultMimeTypes</span>,</span>
<span class="lineno">  378 </span><span class="spaces">    </span><span class="istickedoff">preServeHook = <span class="nottickedoff">const $ return ()</span></span>
<span class="lineno">  379 </span><span class="spaces">    </span><span class="istickedoff">}</span></span>
<span class="lineno">  380 </span>
<span class="lineno">  381 </span>
<span class="lineno">  382 </span>------------------------------------------------------------------------------
<span class="lineno">  383 </span>-- | Serves static files from a directory using the default configuration
<span class="lineno">  384 </span>-- as given in 'defaultDirectoryConfig'.
<span class="lineno">  385 </span>serveDirectory :: MonadSnap m
<span class="lineno">  386 </span>               =&gt; FilePath           -- ^ Directory to serve from
<span class="lineno">  387 </span>               -&gt; m ()
<span class="lineno">  388 </span><span class="decl"><span class="istickedoff">serveDirectory = serveDirectoryWith defaultDirectoryConfig</span></span>
<span class="lineno">  389 </span>{-# INLINE serveDirectory #-}
<span class="lineno">  390 </span>
<span class="lineno">  391 </span>
<span class="lineno">  392 </span>------------------------------------------------------------------------------
<span class="lineno">  393 </span>-- | Serves static files from a directory.  Configuration options are
<span class="lineno">  394 </span>-- passed in a 'DirectoryConfig' that captures various choices about desired
<span class="lineno">  395 </span>-- behavior.  The relative path given in 'rqPathInfo' is searched for a
<span class="lineno">  396 </span>-- requested file, and the file is served with the appropriate mime type if it
<span class="lineno">  397 </span>-- is found. Absolute paths and \&quot;@..@\&quot; are prohibited to prevent files from
<span class="lineno">  398 </span>-- being served from outside the sandbox.
<span class="lineno">  399 </span>serveDirectoryWith :: MonadSnap m
<span class="lineno">  400 </span>                   =&gt; DirectoryConfig m  -- ^ Configuration options
<span class="lineno">  401 </span>                   -&gt; FilePath           -- ^ Directory to serve from
<span class="lineno">  402 </span>                   -&gt; m ()
<span class="lineno">  403 </span><span class="decl"><span class="istickedoff">serveDirectoryWith cfg base = do</span>
<span class="lineno">  404 </span><span class="spaces">    </span><span class="istickedoff">b &lt;- directory &lt;|&gt; file &lt;|&gt; redir</span>
<span class="lineno">  405 </span><span class="spaces">    </span><span class="istickedoff">when (not b) pass</span>
<span class="lineno">  406 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  407 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  408 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  409 </span><span class="spaces">    </span><span class="istickedoff">idxs     = indexFiles cfg</span>
<span class="lineno">  410 </span><span class="spaces">    </span><span class="istickedoff">generate = indexGenerator cfg</span>
<span class="lineno">  411 </span><span class="spaces">    </span><span class="istickedoff">mimes    = mimeTypes cfg</span>
<span class="lineno">  412 </span><span class="spaces">    </span><span class="istickedoff">dyns     = dynamicHandlers cfg</span>
<span class="lineno">  413 </span><span class="spaces">    </span><span class="istickedoff">pshook   = preServeHook cfg</span>
<span class="lineno">  414 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  415 </span><span class="spaces">    </span><span class="istickedoff">-- Serves a file if it exists; passes if not</span>
<span class="lineno">  416 </span><span class="spaces">    </span><span class="istickedoff">serve f = do</span>
<span class="lineno">  417 </span><span class="spaces">        </span><span class="istickedoff">liftIO (doesFileExist f) &gt;&gt;= flip unless pass</span>
<span class="lineno">  418 </span><span class="spaces">        </span><span class="istickedoff">let fname          = takeFileName f</span>
<span class="lineno">  419 </span><span class="spaces">        </span><span class="istickedoff">let staticServe f' = pshook <span class="nottickedoff">f</span> &gt;&gt; serveFileAs (fileType mimes fname) f'</span>
<span class="lineno">  420 </span><span class="spaces">        </span><span class="istickedoff">lookupExt staticServe dyns fname f &gt;&gt; return True &lt;|&gt; <span class="nottickedoff">return False</span></span>
<span class="lineno">  421 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  422 </span><span class="spaces">    </span><span class="istickedoff">-- Serves a directory via indices if available.  Returns True on success,</span>
<span class="lineno">  423 </span><span class="spaces">    </span><span class="istickedoff">-- False on failure to find an index.  Passes /only/ if the request was</span>
<span class="lineno">  424 </span><span class="spaces">    </span><span class="istickedoff">-- not for a directory (no trailing slash).</span>
<span class="lineno">  425 </span><span class="spaces">    </span><span class="istickedoff">directory = do</span>
<span class="lineno">  426 </span><span class="spaces">        </span><span class="istickedoff">rq  &lt;- getRequest</span>
<span class="lineno">  427 </span><span class="spaces">        </span><span class="istickedoff">let uri = uriWithoutQueryString rq</span>
<span class="lineno">  428 </span><span class="spaces">        </span><span class="istickedoff">unless (&quot;/&quot; `S.isSuffixOf` uri) pass</span>
<span class="lineno">  429 </span><span class="spaces">        </span><span class="istickedoff">rel &lt;- (base &lt;/&gt;) &lt;$&gt; getSafePath</span>
<span class="lineno">  430 </span><span class="spaces">        </span><span class="istickedoff">b   &lt;- liftIO $ doesDirectoryExist rel</span>
<span class="lineno">  431 </span><span class="spaces">        </span><span class="istickedoff">if b then do let serveRel f = serve (rel &lt;/&gt; f)</span>
<span class="lineno">  432 </span><span class="spaces">                     </span><span class="istickedoff">foldl' (&lt;|&gt;) pass (Prelude.map serveRel idxs)</span>
<span class="lineno">  433 </span><span class="spaces">                         </span><span class="istickedoff">&lt;|&gt; (generate rel &gt;&gt; return True)</span>
<span class="lineno">  434 </span><span class="spaces">                         </span><span class="istickedoff">&lt;|&gt; return False</span>
<span class="lineno">  435 </span><span class="spaces">             </span><span class="istickedoff">else return False</span>
<span class="lineno">  436 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  437 </span><span class="spaces">    </span><span class="istickedoff">-- Serves a file requested by name.  Passes if the file doesn't exist.</span>
<span class="lineno">  438 </span><span class="spaces">    </span><span class="istickedoff">file = serve =&lt;&lt; ((base &lt;/&gt;) &lt;$&gt; getSafePath)</span>
<span class="lineno">  439 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  440 </span><span class="spaces">    </span><span class="istickedoff">-- If the request is for a directory but lacks a trailing slash, redirects</span>
<span class="lineno">  441 </span><span class="spaces">    </span><span class="istickedoff">-- to the directory name with a trailing slash.</span>
<span class="lineno">  442 </span><span class="spaces">    </span><span class="istickedoff">redir = do</span>
<span class="lineno">  443 </span><span class="spaces">        </span><span class="istickedoff">rel &lt;- (base &lt;/&gt;) &lt;$&gt; getSafePath</span>
<span class="lineno">  444 </span><span class="spaces">        </span><span class="istickedoff">liftIO (doesDirectoryExist rel) &gt;&gt;= flip unless pass</span>
<span class="lineno">  445 </span><span class="spaces">        </span><span class="istickedoff">rq &lt;- getRequest</span>
<span class="lineno">  446 </span><span class="spaces">        </span><span class="istickedoff">let uri = uriWithoutQueryString rq</span>
<span class="lineno">  447 </span><span class="spaces">        </span><span class="istickedoff">let qss = queryStringSuffix rq</span>
<span class="lineno">  448 </span><span class="spaces">        </span><span class="istickedoff">let u = S.concat [uri, &quot;/&quot;, qss]</span>
<span class="lineno">  449 </span><span class="spaces">        </span><span class="istickedoff">redirect u</span></span>
<span class="lineno">  450 </span>
<span class="lineno">  451 </span>
<span class="lineno">  452 </span>------------------------------------------------------------------------------
<span class="lineno">  453 </span>-- | Serves a single file specified by a full or relative path.  If the file
<span class="lineno">  454 </span>-- does not exist, throws an exception (not that it does /not/ pass to the
<span class="lineno">  455 </span>-- next handler).   The path restrictions on 'serveDirectory' don't apply to
<span class="lineno">  456 </span>-- this function since the path is not being supplied by the user.
<span class="lineno">  457 </span>serveFile :: MonadSnap m
<span class="lineno">  458 </span>          =&gt; FilePath          -- ^ path to file
<span class="lineno">  459 </span>          -&gt; m ()
<span class="lineno">  460 </span><span class="decl"><span class="istickedoff">serveFile fp = serveFileAs (fileType defaultMimeTypes (takeFileName fp)) fp</span></span>
<span class="lineno">  461 </span>{-# INLINE serveFile #-}
<span class="lineno">  462 </span>
<span class="lineno">  463 </span>
<span class="lineno">  464 </span>------------------------------------------------------------------------------
<span class="lineno">  465 </span>-- | Same as 'serveFile', with control over the MIME mapping used.
<span class="lineno">  466 </span>serveFileAs :: MonadSnap m
<span class="lineno">  467 </span>            =&gt; ByteString        -- ^ MIME type
<span class="lineno">  468 </span>            -&gt; FilePath          -- ^ path to file
<span class="lineno">  469 </span>            -&gt; m ()
<span class="lineno">  470 </span><span class="decl"><span class="istickedoff">serveFileAs mime fp = do</span>
<span class="lineno">  471 </span><span class="spaces">    </span><span class="istickedoff">reqOrig &lt;- getRequest</span>
<span class="lineno">  472 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  473 </span><span class="spaces">    </span><span class="istickedoff">-- If-Range header must be ignored if there is no Range: header in the</span>
<span class="lineno">  474 </span><span class="spaces">    </span><span class="istickedoff">-- request (RFC 2616 section 14.27)</span>
<span class="lineno">  475 </span><span class="spaces">    </span><span class="istickedoff">let req = if isNothing $ getHeader &quot;range&quot; reqOrig</span>
<span class="lineno">  476 </span><span class="spaces">                </span><span class="istickedoff">then deleteHeader &quot;if-range&quot; reqOrig</span>
<span class="lineno">  477 </span><span class="spaces">                </span><span class="istickedoff">else reqOrig</span>
<span class="lineno">  478 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  479 </span><span class="spaces">    </span><span class="istickedoff">-- check &quot;If-Modified-Since&quot; and &quot;If-Range&quot; headers</span>
<span class="lineno">  480 </span><span class="spaces">    </span><span class="istickedoff">let mbH = getHeader &quot;if-modified-since&quot; req</span>
<span class="lineno">  481 </span><span class="spaces">    </span><span class="istickedoff">mbIfModified &lt;- liftIO $ case mbH of</span>
<span class="lineno">  482 </span><span class="spaces">                               </span><span class="istickedoff">Nothing  -&gt; return Nothing</span>
<span class="lineno">  483 </span><span class="spaces">                               </span><span class="istickedoff">(Just s) -&gt; liftM Just $ parseHttpTime s</span>
<span class="lineno">  484 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  485 </span><span class="spaces">    </span><span class="istickedoff">-- If-Range header could contain an entity, but then parseHttpTime will</span>
<span class="lineno">  486 </span><span class="spaces">    </span><span class="istickedoff">-- fail and return 0 which means a 200 response will be generated anyways</span>
<span class="lineno">  487 </span><span class="spaces">    </span><span class="istickedoff">mbIfRange &lt;- liftIO $ case getHeader &quot;if-range&quot; req of</span>
<span class="lineno">  488 </span><span class="spaces">                            </span><span class="istickedoff">Nothing  -&gt; return Nothing</span>
<span class="lineno">  489 </span><span class="spaces">                            </span><span class="istickedoff">(Just s) -&gt; liftM Just $ parseHttpTime s</span>
<span class="lineno">  490 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  491 </span><span class="spaces">    </span><span class="istickedoff">dbg $ &quot;mbIfModified: &quot; ++ Prelude.show mbIfModified</span>
<span class="lineno">  492 </span><span class="spaces">    </span><span class="istickedoff">dbg $ &quot;mbIfRange: &quot; ++ Prelude.show mbIfRange</span>
<span class="lineno">  493 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  494 </span><span class="spaces">    </span><span class="istickedoff">-- check modification time and bug out early if the file is not modified.</span>
<span class="lineno">  495 </span><span class="spaces">    </span><span class="istickedoff">--</span>
<span class="lineno">  496 </span><span class="spaces">    </span><span class="istickedoff">-- TODO: a stat cache would be nice here, but it'd need the date thread</span>
<span class="lineno">  497 </span><span class="spaces">    </span><span class="istickedoff">-- stuff from snap-server to be folded into snap-core</span>
<span class="lineno">  498 </span><span class="spaces">    </span><span class="istickedoff">filestat &lt;- liftIO $ getFileStatus fp</span>
<span class="lineno">  499 </span><span class="spaces">    </span><span class="istickedoff">let mt = modificationTime filestat</span>
<span class="lineno">  500 </span><span class="spaces">    </span><span class="istickedoff">maybe (return $! ()) (\lt -&gt; when (mt &lt;= lt) notModified) mbIfModified</span>
<span class="lineno">  501 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  502 </span><span class="spaces">    </span><span class="istickedoff">let sz = fromIntegral $ fileSize filestat</span>
<span class="lineno">  503 </span><span class="spaces">    </span><span class="istickedoff">lm &lt;- liftIO $ formatHttpTime mt</span>
<span class="lineno">  504 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  505 </span><span class="spaces">    </span><span class="istickedoff">-- ok, at this point we know the last-modified time and the</span>
<span class="lineno">  506 </span><span class="spaces">    </span><span class="istickedoff">-- content-type. set those.</span>
<span class="lineno">  507 </span><span class="spaces">    </span><span class="istickedoff">modifyResponse $ setHeader &quot;Last-Modified&quot; lm</span>
<span class="lineno">  508 </span><span class="spaces">                   </span><span class="istickedoff">. setHeader &quot;Accept-Ranges&quot; &quot;bytes&quot;</span>
<span class="lineno">  509 </span><span class="spaces">                   </span><span class="istickedoff">. setContentType mime</span>
<span class="lineno">  510 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  511 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  512 </span><span class="spaces">    </span><span class="istickedoff">-- now check: is this a range request? If there is an 'If-Range' header</span>
<span class="lineno">  513 </span><span class="spaces">    </span><span class="istickedoff">-- with an old modification time we skip this check and send a 200</span>
<span class="lineno">  514 </span><span class="spaces">    </span><span class="istickedoff">-- response</span>
<span class="lineno">  515 </span><span class="spaces">    </span><span class="istickedoff">let skipRangeCheck = maybe (False)</span>
<span class="lineno">  516 </span><span class="spaces">                               </span><span class="istickedoff">(\lt -&gt; mt &gt; lt)</span>
<span class="lineno">  517 </span><span class="spaces">                               </span><span class="istickedoff">mbIfRange</span>
<span class="lineno">  518 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  519 </span><span class="spaces">    </span><span class="istickedoff">-- checkRangeReq checks for a Range: header in the request and sends a</span>
<span class="lineno">  520 </span><span class="spaces">    </span><span class="istickedoff">-- partial response if it matches.</span>
<span class="lineno">  521 </span><span class="spaces">    </span><span class="istickedoff">wasRange &lt;- if skipRangeCheck</span>
<span class="lineno">  522 </span><span class="spaces">                  </span><span class="istickedoff">then return False</span>
<span class="lineno">  523 </span><span class="spaces">                  </span><span class="istickedoff">else liftSnap $ checkRangeReq req fp sz</span>
<span class="lineno">  524 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  525 </span><span class="spaces">    </span><span class="istickedoff">dbg $ &quot;was this a range request? &quot; ++ Prelude.show wasRange</span>
<span class="lineno">  526 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  527 </span><span class="spaces">    </span><span class="istickedoff">-- if we didn't have a range request, we just do normal sendfile</span>
<span class="lineno">  528 </span><span class="spaces">    </span><span class="istickedoff">unless wasRange $ do</span>
<span class="lineno">  529 </span><span class="spaces">      </span><span class="istickedoff">modifyResponse $ setResponseCode 200</span>
<span class="lineno">  530 </span><span class="spaces">                     </span><span class="istickedoff">. setContentLength sz</span>
<span class="lineno">  531 </span><span class="spaces">      </span><span class="istickedoff">liftSnap $ sendFile fp</span>
<span class="lineno">  532 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  533 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  534 </span><span class="spaces">    </span><span class="istickedoff">--------------------------------------------------------------------------</span>
<span class="lineno">  535 </span><span class="spaces">    </span><span class="istickedoff">notModified = finishWith $</span>
<span class="lineno">  536 </span><span class="spaces">                  </span><span class="istickedoff">setResponseCode 304 emptyResponse</span></span>
<span class="lineno">  537 </span>
<span class="lineno">  538 </span>
<span class="lineno">  539 </span>------------------------------------------------------------------------------
<span class="lineno">  540 </span>lookupExt :: a -&gt; Map FilePath a -&gt; FilePath -&gt; a
<span class="lineno">  541 </span><span class="decl"><span class="istickedoff">lookupExt def m f =</span>
<span class="lineno">  542 </span><span class="spaces">    </span><span class="istickedoff">if null ext</span>
<span class="lineno">  543 </span><span class="spaces">      </span><span class="istickedoff">then def</span>
<span class="lineno">  544 </span><span class="spaces">      </span><span class="istickedoff">else fromMaybe (lookupExt def m (drop 1 ext)) mbe</span>
<span class="lineno">  545 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  546 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  547 </span><span class="spaces">    </span><span class="istickedoff">ext             = takeExtensions f</span>
<span class="lineno">  548 </span><span class="spaces">    </span><span class="istickedoff">mbe             = Map.lookup ext m</span></span>
<span class="lineno">  549 </span>
<span class="lineno">  550 </span>
<span class="lineno">  551 </span>------------------------------------------------------------------------------
<span class="lineno">  552 </span>fileType :: MimeMap -&gt; FilePath -&gt; ByteString
<span class="lineno">  553 </span><span class="decl"><span class="istickedoff">fileType = lookupExt defaultMimeType</span></span>
<span class="lineno">  554 </span>
<span class="lineno">  555 </span>
<span class="lineno">  556 </span>------------------------------------------------------------------------------
<span class="lineno">  557 </span>defaultMimeType :: ByteString
<span class="lineno">  558 </span><span class="decl"><span class="istickedoff">defaultMimeType = &quot;application/octet-stream&quot;</span></span>
<span class="lineno">  559 </span>
<span class="lineno">  560 </span>
<span class="lineno">  561 </span>------------------------------------------------------------------------------
<span class="lineno">  562 </span>data <span class="nottickedoff">RangeReq</span> = RangeReq { _rangeFirst :: !Int64
<span class="lineno">  563 </span>                         , _rangeLast  :: !(Maybe Int64)
<span class="lineno">  564 </span>                         }
<span class="lineno">  565 </span>              | SuffixRangeReq { _suffixLength :: !Int64 }
<span class="lineno">  566 </span>  deriving (<span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Eq</span></span></span></span>, <span class="decl"><span class="istickedoff"><span class="decl"><span class="nottickedoff">Prelude.Show</span></span></span></span>)
<span class="lineno">  567 </span>
<span class="lineno">  568 </span>
<span class="lineno">  569 </span>------------------------------------------------------------------------------
<span class="lineno">  570 </span>rangeParser :: Parser RangeReq
<span class="lineno">  571 </span><span class="decl"><span class="istickedoff">rangeParser = string &quot;bytes=&quot; *&gt;</span>
<span class="lineno">  572 </span><span class="spaces">              </span><span class="istickedoff">(byteRangeSpec &lt;|&gt; suffixByteRangeSpec) &lt;*</span>
<span class="lineno">  573 </span><span class="spaces">              </span><span class="istickedoff">endOfInput</span>
<span class="lineno">  574 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  575 </span><span class="spaces">    </span><span class="istickedoff">byteRangeSpec = do</span>
<span class="lineno">  576 </span><span class="spaces">        </span><span class="istickedoff">start &lt;- parseNum</span>
<span class="lineno">  577 </span><span class="spaces">        </span><span class="istickedoff">char '-'</span>
<span class="lineno">  578 </span><span class="spaces">        </span><span class="istickedoff">end   &lt;- option Nothing $ liftM Just parseNum</span>
<span class="lineno">  579 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  580 </span><span class="spaces">        </span><span class="istickedoff">return $ RangeReq start end</span>
<span class="lineno">  581 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  582 </span><span class="spaces">    </span><span class="istickedoff">suffixByteRangeSpec = liftM SuffixRangeReq $ char '-' *&gt; parseNum</span></span>
<span class="lineno">  583 </span>
<span class="lineno">  584 </span>
<span class="lineno">  585 </span>------------------------------------------------------------------------------
<span class="lineno">  586 </span>checkRangeReq :: (MonadSnap m) =&gt; Request -&gt; FilePath -&gt; Int64 -&gt; m Bool
<span class="lineno">  587 </span><span class="decl"><span class="istickedoff">checkRangeReq req fp sz = do</span>
<span class="lineno">  588 </span><span class="spaces">    </span><span class="istickedoff">-- TODO/FIXME: multiple ranges</span>
<span class="lineno">  589 </span><span class="spaces">    </span><span class="istickedoff">dbg $ &quot;checkRangeReq, fp=&quot; ++ fp ++ &quot;, sz=&quot; ++ Prelude.show sz</span>
<span class="lineno">  590 </span><span class="spaces">    </span><span class="istickedoff">maybe (return False)</span>
<span class="lineno">  591 </span><span class="spaces">          </span><span class="istickedoff">(\s -&gt; either (const $ return False)</span>
<span class="lineno">  592 </span><span class="spaces">                        </span><span class="istickedoff">withRange</span>
<span class="lineno">  593 </span><span class="spaces">                        </span><span class="istickedoff">(fullyParse s rangeParser))</span>
<span class="lineno">  594 </span><span class="spaces">          </span><span class="istickedoff">(getHeader &quot;range&quot; req)</span>
<span class="lineno">  595 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  596 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  597 </span><span class="spaces">    </span><span class="istickedoff">withRange rng@(RangeReq start mend) = do</span>
<span class="lineno">  598 </span><span class="spaces">        </span><span class="istickedoff">dbg $ &quot;withRange: got Range request: &quot; ++ Prelude.show rng</span>
<span class="lineno">  599 </span><span class="spaces">        </span><span class="istickedoff">let end = fromMaybe (sz-1) mend</span>
<span class="lineno">  600 </span><span class="spaces">        </span><span class="istickedoff">dbg $ &quot;withRange: start=&quot; ++ Prelude.show start</span>
<span class="lineno">  601 </span><span class="spaces">                  </span><span class="istickedoff">++ &quot;, end=&quot; ++ Prelude.show end</span>
<span class="lineno">  602 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  603 </span><span class="spaces">        </span><span class="istickedoff">if start &lt; 0 || end &lt; start || start &gt;= sz || end &gt;= sz</span>
<span class="lineno">  604 </span><span class="spaces">           </span><span class="istickedoff">then send416</span>
<span class="lineno">  605 </span><span class="spaces">           </span><span class="istickedoff">else send206 start end</span>
<span class="lineno">  606 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  607 </span><span class="spaces">    </span><span class="istickedoff">withRange rng@(SuffixRangeReq nbytes) = do</span>
<span class="lineno">  608 </span><span class="spaces">        </span><span class="istickedoff">dbg $ &quot;withRange: got Range request: &quot; ++ Prelude.show rng</span>
<span class="lineno">  609 </span><span class="spaces">        </span><span class="istickedoff">let end   = sz-1</span>
<span class="lineno">  610 </span><span class="spaces">        </span><span class="istickedoff">let start = sz - nbytes</span>
<span class="lineno">  611 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  612 </span><span class="spaces">        </span><span class="istickedoff">dbg $ &quot;withRange: start=&quot; ++ Prelude.show start</span>
<span class="lineno">  613 </span><span class="spaces">                  </span><span class="istickedoff">++ &quot;, end=&quot; ++ Prelude.show end</span>
<span class="lineno">  614 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  615 </span><span class="spaces">        </span><span class="istickedoff">if start &lt; 0 || end &lt; start || start &gt;= sz || end &gt;= sz</span>
<span class="lineno">  616 </span><span class="spaces">           </span><span class="istickedoff">then send416</span>
<span class="lineno">  617 </span><span class="spaces">           </span><span class="istickedoff">else send206 start end</span>
<span class="lineno">  618 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  619 </span><span class="spaces">    </span><span class="istickedoff">-- note: start and end INCLUSIVE here</span>
<span class="lineno">  620 </span><span class="spaces">    </span><span class="istickedoff">send206 start end = do</span>
<span class="lineno">  621 </span><span class="spaces">        </span><span class="istickedoff">dbg &quot;inside send206&quot;</span>
<span class="lineno">  622 </span><span class="spaces">        </span><span class="istickedoff">let len = end-start+1</span>
<span class="lineno">  623 </span><span class="spaces">        </span><span class="istickedoff">let crng = toByteString $</span>
<span class="lineno">  624 </span><span class="spaces">                   </span><span class="istickedoff">mconcat [ fromByteString &quot;bytes &quot;</span>
<span class="lineno">  625 </span><span class="spaces">                           </span><span class="istickedoff">, fromShow start</span>
<span class="lineno">  626 </span><span class="spaces">                           </span><span class="istickedoff">, fromWord8 (c2w '-')</span>
<span class="lineno">  627 </span><span class="spaces">                           </span><span class="istickedoff">, fromShow end</span>
<span class="lineno">  628 </span><span class="spaces">                           </span><span class="istickedoff">, fromWord8 (c2w '/')</span>
<span class="lineno">  629 </span><span class="spaces">                           </span><span class="istickedoff">, fromShow sz ]</span>
<span class="lineno">  630 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  631 </span><span class="spaces">        </span><span class="istickedoff">modifyResponse $ setResponseCode 206</span>
<span class="lineno">  632 </span><span class="spaces">                       </span><span class="istickedoff">. setHeader &quot;Content-Range&quot; crng</span>
<span class="lineno">  633 </span><span class="spaces">                       </span><span class="istickedoff">. setContentLength len</span>
<span class="lineno">  634 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  635 </span><span class="spaces">        </span><span class="istickedoff">dbg $ &quot;send206: sending range (&quot; ++ Prelude.show start</span>
<span class="lineno">  636 </span><span class="spaces">                </span><span class="istickedoff">++ &quot;,&quot; ++ Prelude.show (end+1) ++ &quot;) to sendFilePartial&quot;</span>
<span class="lineno">  637 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  638 </span><span class="spaces">        </span><span class="istickedoff">-- end here was inclusive, sendFilePartial is exclusive</span>
<span class="lineno">  639 </span><span class="spaces">        </span><span class="istickedoff">sendFilePartial fp (start,end+1)</span>
<span class="lineno">  640 </span><span class="spaces">        </span><span class="istickedoff">return True</span>
<span class="lineno">  641 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  642 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  643 </span><span class="spaces">    </span><span class="istickedoff">send416 = do</span>
<span class="lineno">  644 </span><span class="spaces">        </span><span class="istickedoff">dbg &quot;inside send416&quot;</span>
<span class="lineno">  645 </span><span class="spaces">        </span><span class="istickedoff">-- if there's an &quot;If-Range&quot; header in the request, then we just send</span>
<span class="lineno">  646 </span><span class="spaces">        </span><span class="istickedoff">-- back 200</span>
<span class="lineno">  647 </span><span class="spaces">        </span><span class="istickedoff">if getHeader &quot;If-Range&quot; req /= Nothing</span>
<span class="lineno">  648 </span><span class="spaces">           </span><span class="istickedoff">then return False</span>
<span class="lineno">  649 </span><span class="spaces">           </span><span class="istickedoff">else do</span>
<span class="lineno">  650 </span><span class="spaces">               </span><span class="istickedoff">let crng = toByteString $</span>
<span class="lineno">  651 </span><span class="spaces">                          </span><span class="istickedoff">mconcat [ fromByteString &quot;bytes */&quot;</span>
<span class="lineno">  652 </span><span class="spaces">                                  </span><span class="istickedoff">, fromShow sz ]</span>
<span class="lineno">  653 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  654 </span><span class="spaces">               </span><span class="istickedoff">modifyResponse $ setResponseCode 416</span>
<span class="lineno">  655 </span><span class="spaces">                              </span><span class="istickedoff">. setHeader &quot;Content-Range&quot; crng</span>
<span class="lineno">  656 </span><span class="spaces">                              </span><span class="istickedoff">. setContentLength 0</span>
<span class="lineno">  657 </span><span class="spaces">                              </span><span class="istickedoff">. deleteHeader &quot;Content-Type&quot;</span>
<span class="lineno">  658 </span><span class="spaces">                              </span><span class="istickedoff">. deleteHeader &quot;Content-Encoding&quot;</span>
<span class="lineno">  659 </span><span class="spaces">                              </span><span class="istickedoff">. deleteHeader &quot;Transfer-Encoding&quot;</span>
<span class="lineno">  660 </span><span class="spaces">                              </span><span class="istickedoff">. setResponseBody (enumBuilder mempty)</span>
<span class="lineno">  661 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  662 </span><span class="spaces">               </span><span class="istickedoff">return True</span></span>
<span class="lineno">  663 </span>
<span class="lineno">  664 </span>
<span class="lineno">  665 </span>------------------------------------------------------------------------------
<span class="lineno">  666 </span>dbg :: (MonadIO m) =&gt; String -&gt; m ()
<span class="lineno">  667 </span><span class="decl"><span class="istickedoff">dbg s = debug $ &quot;FileServe:&quot; ++ s</span></span>
<span class="lineno">  668 </span>
<span class="lineno">  669 </span>
<span class="lineno">  670 </span>------------------------------------------------------------------------------
<span class="lineno">  671 </span>-- Obsolete functions retained for compatibility.
<span class="lineno">  672 </span>------------------------------------------------------------------------------
<span class="lineno">  673 </span>
<span class="lineno">  674 </span>------------------------------------------------------------------------------
<span class="lineno">  675 </span>-- | Serves files out of the given directory, using no index files and default
<span class="lineno">  676 </span>-- MIME types.
<span class="lineno">  677 </span>--
<span class="lineno">  678 </span>-- The function name is obsolete.  You should use 'serveDirectory' or
<span class="lineno">  679 </span>-- 'serveDirectoryWith' instead, which do similar things but with more options
<span class="lineno">  680 </span>-- and clearer, more consistent names.
<span class="lineno">  681 </span>fileServe :: MonadSnap m
<span class="lineno">  682 </span>          =&gt; FilePath  -- ^ root directory
<span class="lineno">  683 </span>          -&gt; m ()
<span class="lineno">  684 </span><span class="decl"><span class="nottickedoff">fileServe = serveDirectoryWith simpleDirectoryConfig</span></span>
<span class="lineno">  685 </span>{-# INLINE fileServe #-}
<span class="lineno">  686 </span>{-# DEPRECATED fileServe &quot;Use serveDirectory or serveDirectoryWith&quot; #-}
<span class="lineno">  687 </span>
<span class="lineno">  688 </span>
<span class="lineno">  689 </span>------------------------------------------------------------------------------
<span class="lineno">  690 </span>-- | Serves files out of the given directory, with a given MIME type mapping.
<span class="lineno">  691 </span>--
<span class="lineno">  692 </span>-- The function name is obsolete.  You should use 'serveDirectoryWith'
<span class="lineno">  693 </span>-- instead, which offers more options and a clearer, more consistent name.
<span class="lineno">  694 </span>fileServe' :: MonadSnap m
<span class="lineno">  695 </span>           =&gt; MimeMap           -- ^ MIME type mapping
<span class="lineno">  696 </span>           -&gt; FilePath          -- ^ root directory
<span class="lineno">  697 </span>           -&gt; m ()
<span class="lineno">  698 </span><span class="decl"><span class="nottickedoff">fileServe' mm = serveDirectoryWith (simpleDirectoryConfig { mimeTypes = mm })</span></span>
<span class="lineno">  699 </span>{-# INLINE fileServe' #-}
<span class="lineno">  700 </span>{-# DEPRECATED fileServe' &quot;Use serveDirectoryWith instead&quot; #-}
<span class="lineno">  701 </span>
<span class="lineno">  702 </span>
<span class="lineno">  703 </span>------------------------------------------------------------------------------
<span class="lineno">  704 </span>-- | Serves a single file specified by a full or relative path.  The
<span class="lineno">  705 </span>-- path restrictions on fileServe don't apply to this function since
<span class="lineno">  706 </span>-- the path is not being supplied by the user.
<span class="lineno">  707 </span>--
<span class="lineno">  708 </span>-- The function name is obsolete.  You should use 'serveFile' instead, which
<span class="lineno">  709 </span>-- does the same thing but with a clearer, more consistent name.
<span class="lineno">  710 </span>fileServeSingle :: MonadSnap m
<span class="lineno">  711 </span>                =&gt; FilePath          -- ^ path to file
<span class="lineno">  712 </span>                -&gt; m ()
<span class="lineno">  713 </span><span class="decl"><span class="nottickedoff">fileServeSingle = serveFile</span></span>
<span class="lineno">  714 </span>{-# INLINE fileServeSingle #-}
<span class="lineno">  715 </span>{-# DEPRECATED fileServeSingle &quot;Use serveFile instead&quot; #-}
<span class="lineno">  716 </span>
<span class="lineno">  717 </span>
<span class="lineno">  718 </span>------------------------------------------------------------------------------
<span class="lineno">  719 </span>-- | Same as 'fileServeSingle', with control over the MIME mapping used.
<span class="lineno">  720 </span>--
<span class="lineno">  721 </span>-- The function name is obsolete.  You should use 'serveFileAs' instead, which
<span class="lineno">  722 </span>-- does the same thing but with a clearer, more consistent name.
<span class="lineno">  723 </span>fileServeSingle' :: MonadSnap m
<span class="lineno">  724 </span>                 =&gt; ByteString        -- ^ MIME type mapping
<span class="lineno">  725 </span>                 -&gt; FilePath          -- ^ path to file
<span class="lineno">  726 </span>                 -&gt; m ()
<span class="lineno">  727 </span><span class="decl"><span class="nottickedoff">fileServeSingle' = serveFileAs</span></span>
<span class="lineno">  728 </span>{-# INLINE fileServeSingle' #-}
<span class="lineno">  729 </span>{-# DEPRECATED fileServeSingle' &quot;Use serveFileAs instead&quot; #-}
<span class="lineno">  730 </span>
<span class="lineno">  731 </span>
<span class="lineno">  732 </span>------------------------------------------------------------------------------
<span class="lineno">  733 </span>uriWithoutQueryString :: Request -&gt; ByteString
<span class="lineno">  734 </span><span class="decl"><span class="istickedoff">uriWithoutQueryString rq = S.concat [ cp, pinfo ]</span>
<span class="lineno">  735 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  736 </span><span class="spaces">    </span><span class="istickedoff">cp    = rqContextPath rq</span>
<span class="lineno">  737 </span><span class="spaces">    </span><span class="istickedoff">pinfo = rqPathInfo rq</span></span>
<span class="lineno">  738 </span>
<span class="lineno">  739 </span>
<span class="lineno">  740 </span>------------------------------------------------------------------------------
<span class="lineno">  741 </span>queryStringSuffix :: Request -&gt; ByteString
<span class="lineno">  742 </span><span class="decl"><span class="istickedoff">queryStringSuffix rq = S.concat [ s, qs ]</span>
<span class="lineno">  743 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  744 </span><span class="spaces">    </span><span class="istickedoff">qs = rqQueryString rq</span>
<span class="lineno">  745 </span><span class="spaces">    </span><span class="istickedoff">s  = if S.null qs then &quot;&quot; else &quot;?&quot;</span></span>

</pre>
</html>
